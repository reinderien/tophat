$(document).ready(function () { var i = {}; var o = function (H) { return H * H }, m = function (I, K) { I = Math.abs(I); K = Math.abs(K); var J = Math.max(I, K), H = Math.min(I, K) / (J ? J : 1); return J * Math.sqrt(1 + H * H) }, l = function (H) { var J = 1 + H, I = J - 1; return I == 0 ? H : H * Math.log(J) / I }, g = function (H) { var I = Math.abs(H); I = l(I * (1 + I / (m(1, I) + 1))); return H < 0 ? -I : I }, c = function (H) { var I = Math.abs(H); I = l(2 * I / (1 - I)) / 2; return H < 0 ? -I : I }, z = function (K, J) { var L = K + J, H = L - J, I = L - H; H -= K; I -= J; t = -(H + I); return { s: L, t: t } }, p = function (H) { return H >= 180 ? H - 360 : (H < -180 ? H + 360 : H) }, r = function (H, M) { var L = M - H, K = L + H, J = K - L; K -= M; J -= H; var I = J - K; if ((L - 180) + I > 0) { L -= 360 } else { if ((L + 180) + I <= 0) { L += 360 } } return L + I }, E = 53, s = Math.PI / 180, k = Math.pow(0.5, E - 1), h = 1 / o(k), w = function (H) { var I = Math.tan(H); return H >= 0 ? (!(I < 0) ? I : h) : (!(I >= 0) ? I : -h) }, v = function (T, Q, J) { var V = 6, M = 5, W = [], K = [], O = Q <= 1 ? Q : 1 / Q, H = O / (2 - O), I = O * (2 - O), P = Math.sqrt(Math.abs(I)), R = function (X) { return O >= 0 ? P * c(P * X) : -P * Math.atan(P * X) }, N = o(H), L = 1 / (1 + H) * (N * (N * (N + 4) + 64) + 256) / 256, U = L * T; W[1] = H * (H * (H * (H * (H * (31564 * H - 66675) + 34440) + 47250) - 100800) + 75600) / 151200; K[1] = H * (H * (H * (H * (H * (384796 * H - 382725) - 6720) + 932400) - 1612800) + 1209600) / 2419200; W[2] = N * (H * (H * ((863232 - 1983433 * H) * H + 748608) - 1161216) + 524160) / 1935360; K[2] = N * (H * (H * ((1695744 - 1118711 * H) * H - 1174656) + 258048) + 80640) / 3870720; N *= H; W[3] = N * (H * (H * (670412 * H + 406647) - 533952) + 184464) / 725760; K[3] = N * (H * (H * (22276 * H - 16929) - 15984) + 12852) / 362880; N *= H; W[4] = N * (H * (6601661 * H - 7732800) + 2230245) / 7257600; K[4] = N * ((-830251 * H - 158400) * H + 197865) / 7257600; N *= H; W[5] = (3438171 - 13675556 * H) * N / 7983360; K[5] = (453717 - 435388 * H) * N / 15966720; N *= H; W[6] = 212378941 * N / 319334400; K[6] = 20648693 * N / 638668800; var S = function (X) { if (!(Math.abs(X) < h)) { return X } var Z = m(1, X), Y = Math.sinh(R(X / Z)); return m(1, Y) * X - Y * Z }; return function (aB, ag, ad) { ad = r(p(aB), p(ad)); var aj = ag < 0 ? -1 : 1, aC = ad < 0 ? -1 : 1; ad *= aC; ag *= aj; var ak = ad > 90; if (ak) { if (ag == 0) { aj = -1 } ad = 180 - ad } var aa = ag * s, al = ad * s; var az, ax; if (ag != 90) { var aA = Math.max(0, Math.cos(al)), av = Math.tan(aa), ah = S(av); ax = Math.atan2(ah, aA); az = g(Math.sin(al) / m(ah, aA)) } else { ax = Math.PI / 2; az = 0 } var at = Math.cos(2 * ax), ab = Math.cosh(2 * az), Z = Math.sin(2 * ax), aD = Math.sinh(2 * az), am = 2 * at * ab, ay = -2 * Z * aD, aq = V, Y = (aq & 1 ? W[aq] : 0), ae = 0, X = 0, ac = 0, aw = (aq & 1 ? 2 * V * W[aq--] : 0), ap = 0, au = 0, ao = 0; while (aq) { X = am * Y - ay * ae - X + W[aq]; ac = ay * Y + am * ae - ac; au = am * aw - ay * ap - au + 2 * aq * W[aq]; ao = ay * aw + am * ap - ao; --aq; Y = am * X - ay * ac - Y + W[aq]; ae = ay * X + am * ac - ae; aw = am * au - ay * ao - aw + 2 * aq * W[aq]; ap = ay * au + am * ao - ap; --aq } am /= 2; ay /= 2; am = Z * ab; ay = at * aD; var an = ax + am * Y - ay * ae, af = az + ay * Y + am * ae; return { y: U * J * (ak ? Math.PI - an : an) * aj, x: U * J * af * aC } } }, e = function (I, L, J) { var M = function (O) { return N >= 0 ? _e * c(_e * O) : -_e * Math.atan(_e * O) }, N = L <= 1 ? L : 1 / L, K = exp(M(1)), H = (1 - N) * K; return function (S, U, O) { U *= S ? 1 : -1; var T = U * s, R = U != -90 ? w(T) : -h, P = m(1, R), X = Math.sinh(M(R / P)), Q = m(1, X) * R - X * P, V = m(1, Q) + Math.abs(Q); V = Q >= 0 ? (U != 90 ? 1 / V : 0) : V; V *= 2 * J * I / H; O = p(O); var W = O * s; return { x: V * (O == -180 ? 0 : Math.sin(W)), y: (S ? -V : V) * (Math.abs(O) == 90 ? 0 : Math.cos(W)) } } }; i.UTMUPS = { Forward: function (L, I, P, J, N, K, R, M, Q) { var H = 0, T = L >= 0, O, S = Q != H; if (S) { O = v(P, J, N)(K, L, I) } else { O = e(P, J, N)(T, L, I) } O.x += R; O.y += M; return O } }; var d = function (H) { return "(" + Math.floor(H / 100000) + ")" + (1000000000 + Math.floor(H) + "").slice(-5) }, G = null, f = null, j = {}, B = function () { var K = "Geographic: " + G.toFixed(6) + "°," + f.toFixed(6) + "°<br/>", H = false; for (var M in j) { var I = j[M]; if (G >= I.W && G <= I.E && f >= I.S && f <= I.N) { var L = I.proj, J = i.UTMUPS.Forward(f, G, L.semiaxis, 1 / L.denflat, L.sfctrmer, L.longcm, L.feast, L.fnorth, L.zone); K += "UTM: " + d(J.x) + "," + d(J.y) + '<br/><a href="' + I.link + '">' + I.prod.title + "</a>"; H = true; break } } if (!H) { K += "Loading..." } $("#map-info").html(K); return H }, q = [], a = false, D = function () { var H = q.pop(); if (H) { H() } else { a = false; console.log("Fetch done.") } }, x = function (I, H) { var J = $(":root spref horizsys", I); H.proj = { zone: parseInt($(":root planar gridsys utm utmzone          ", J).text()), sfctrmer: parseFloat($(":root planar gridsys utm transmer sfctrmer", J).text()), longcm: parseFloat($(":root planar gridsys utm transmer longcm  ", J).text()), latprjo: parseFloat($(":root planar gridsys utm transmer latprjo ", J).text()), feast: parseFloat($(":root planar gridsys utm transmer feast   ", J).text()), fnorth: parseFloat($(":root planar gridsys utm transmer fnorth  ", J).text()), semiaxis: parseFloat($(":root geodetic semiaxis                   ", J).text()), denflat: parseFloat($(":root geodetic denflat                    ", J).text()) }; j[H.prod.id] = H; if (B()) { q = [] } D() }, b = function (H) { return H.W.toFixed(2) + "_" + H.E.toFixed(2) + "/" + H.S.toFixed(2) + "_" + H.N.toFixed(2) + " - " + H.prod.title }, u = "http://localhost:8083", n = function (H, I) { return function () { var M = H.geometry.coordinates[0], J = { prod: H, link: I.link, W: 500, E: -500, S: 500, N: -500 }, L = u + "/zipproxy/fgdc_en.xml/" + I.link; for (var K in M) { J.W = Math.min(J.W, M[K][0]); J.E = Math.max(J.E, M[K][0]); J.S = Math.min(J.S, M[K][1]); J.N = Math.max(J.N, M[K][1]) } console.log("Getting " + b(J) + " -> " + L); $.ajax(L, { success: function (N) { x(N, J) }, error: function (P, N, O) { console.log(N + " - " + O) } }) } }, C = function (N, M, I) { for (var J in I.products) { var L = I.products[J], P = false; if (L.datasetScale != 50000) { continue } var H = j[L.id]; if (H) { console.log("Cached " + b(H)); continue } for (var K in L.files) { var O = L.files[K]; if (O.description.indexOf("Download file in " > -1)) { console.log("Queueing " + O.link); q.push(n(L, O)); P = true; break } } if (!P) { console.log("Warning: no matching files in product") } } D() }, A = function (J, I) { G = J.latLng.lng(); f = J.latLng.lat(); if (!B() && !a) { a = true; var M = 0.5 * Math.floor(G / 0.5) - 0.1, K = M + 0.2, N = 0.25 * Math.floor(f / 0.25) - 0.01, L = N + 0.02, H = u + "/proxy/http:/geogratis.gc.ca/api/en/nrcan-rncan/ess-sst/-/AND/(urn:iso:series)canmatrix-print-ready/(urn:iso:type)map?alt=json&entry-type=full&max-results=9&bbox=" + M.toFixed(1) + "," + N.toFixed(2) + "," + K.toFixed(1) + "," + L.toFixed(2); console.log("Fetching " + H); $.ajax(H, { success: function (O) { C(G, f, O) }, error: function (Q, O, P) { console.log(O + " - " + P) } }) } }, y = google.maps, F = function (J) { var H = { center: J, zoom: 18, mapTypeId: y.MapTypeId.HYBRID }, I = new y.Map($("#map-canvas").get(0), H); y.event.addListener(I, "mousemove", function (K) { A(K) }) }; navigator.geolocation.getCurrentPosition(function (H) { F({ lat: H.coords.latitude, lng: H.coords.longitude }) }, function (H) { console.log(H); F({ lat: 48.4353, lng: -89.2268 }) }) });
